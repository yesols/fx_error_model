---
title: "Figures"
author: "Yesol Sapozhnikov"
date: '2022-06-09'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Get data frames for plotting

Load libraries and build data frames for plots.
```{r}
library(tidyverse)
library(ggpubr)

# Full tables:
fold <- read.csv("../outputs/table_full_f.csv")
bind <- read.csv("../outputs/table_full_b.csv")
# FoldX-only tables:
foldx <- read.csv("../outputs/table_fxonly_f.csv")
bindx <- read.csv("../outputs/table_fxonly_b.csv")
# selected models from stepwise & best subset selection
mods <- readRDS("../outputs/models.rds")
# source LOsysOCV function
source("../scripts/functions.R")

# Run LOOCV to create dataframes
loo_fold <- loocv(formula(mods$mod_subset_f), fold)$df
loo_bind <- loocv(formula(mods$mod_subset_b), bind)$df
```

## Table: System-by-system breakdown

```{r}
loo_fold %>% group_by(systems) %>%
  summarise(n = n(),
            median_error = median(error),
            coverage = round(mean(test),2),
            width = median(upr))
```

```{r}
loo_bind %>% group_by(systems) %>%
  summarise(n = n(),
            median_error = median(error),
            coverage = round(mean(test),2),
            width = median(upr))
```


## Prediction interval plot with "misses"

Overall plots
```{r}
errors_all_fold <- loo_fold %>% arrange(upr) %>%
  ggplot(aes(x = seq_along(error), y = error)) +
  geom_point(aes(color = test)) +
  geom_line(aes(x = seq_along(error), y = upr, color = "upper bound")) +
  scale_color_manual(values = c("red", "black", "blue"),
                     labels = c("error above bound", "error within bound","predicted upper bound"),
                     guide = guide_legend(override.aes = list(
                       linetype = c("blank","blank","solid"),
                       shape = c(16,16,NA)
                     ))) +  
  theme_light() +
  scale_x_continuous(NULL, breaks = NULL) +
  labs(y = "error (kcal/mol)") +
  annotate("text", x = 100, y = 12.5, label = "Fold data", size = 8) +
  theme(legend.position = c(0.7,0.8), legend.title = element_blank())
errors_all_bind <- loo_bind %>% arrange(upr) %>%
  ggplot(aes(x = seq_along(error), y = error)) +
  geom_point(aes(color = test)) +
  geom_line(aes(x = seq_along(error), y = upr, color = "upper bound")) +
  scale_color_manual(values = c("red", "black", "blue"),
                     labels = c("error above bound", "error within bound","predicted upper bound"),
                     guide = guide_legend(override.aes = list(
                       linetype = c("blank","blank","solid"),
                       shape = c(16,16,NA)
                     ))) +  
  theme_light() +
  scale_x_continuous(NULL, breaks = NULL) +
  labs(y = "error (kcal/mol)") +
  annotate("text", x = 90, y = 15.7, label = "Bind data", size = 8) +
  theme(legend.position = c(0.7,0.8), legend.title = element_blank())
```

Breakdown by system
```{r}
errors_sys_fold <- loo_fold %>% arrange(upr) %>%
  ggplot(aes(y=error,x=seq_along(error))) +
  geom_point(aes(color=test), size = .8, show.legend = FALSE) +
  geom_line(aes(x=seq_along(error), y=upr), color="blue") +
  scale_color_manual(values = c("#FF0000", "#000000")) +
  facet_wrap(~systems, nrow = 2) +
  theme_bw() + labs(y = "error (kcal/mol)") +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white"))
errors_sys_bind <- loo_bind %>% arrange(upr) %>% 
  ggplot(aes(y=error,x=seq_along(error))) +
  geom_point(aes(color=test), size = .8, show.legend = FALSE) +
  geom_line(aes(x=seq_along(error), y=upr), color="blue") +
  scale_color_manual(values = c("#FF0000", "#000000")) +
  theme_bw() + labs(y = "error (kcal/mol)") +
  facet_wrap(~systems, nrow = 2) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        strip.background = element_rect(fill = "white"))
```

Arragne plots
```{r}
ggarrange(errors_all_fold, errors_sys_fold, errors_all_bind, errors_sys_bind,
          labels = c("A","B","C","D"),
          ncol = 2, nrow = 2)
ggsave("../figures/errors_sorted.png", width = 11, height = 9)
```


## Correlation between ddG and error

```{r}
ggplot(loo_fold, aes(x = ddg_exp, y = error)) +
  geom_point(aes(color = test)) +
  labs(x = "ddG", y = "error")
```
```{r}
ggplot(loo_bind, aes(x = ddg_exp, y = error)) +
  geom_point(aes(color = test)) +
  labs(x = "ddG", y = "error")
```




## Predicted stability effects vs actual effects

If we classify stability effects according to ddG, how concordant are they between actual and predicted?
Cut off at +/- 0.5 kcal/mol as in Khan & Vihinen.

```{r}
binned <- loo_fold %>% 
  select(systems, mut, ddg_exp, total, error, test) %>%
  rename(ddg_pred = total) %>%
  mutate(classes_pred = cut(ddg_pred, c(-Inf, -.5, .5, Inf),
                           labels = c("stabilizing", "neutral", "destabilizing")),
         classes_actual = cut(ddg_exp, c(-Inf, -.5, .5, Inf),
                           labels = c("stabilizing", "neutral", "destabilizing")))
ggplot(binned, aes(fill = classes_actual, x = classes_pred)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("blue", "darkgray", "red")) +
  theme_classic()
```

```{r}
binned_bind <- loo_bind %>% 
  select(systems, mut, ddg_exp, total, error, test) %>%
  rename(ddg_pred = total) %>%
  mutate(classes_pred = cut(ddg_pred, c(-Inf, -.5, .5, Inf),
                           labels = c("stabilizing", "neutral", "destabilizing")),
         classes_actual = cut(ddg_exp, c(-Inf, -.5, .5, Inf),
                           labels = c("stabilizing", "neutral", "destabilizing")))
ggplot(binned_bind, aes(fill = classes_actual, x = classes_pred)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("blue", "darkgray", "red")) +
  theme_classic()
```

Combine fold and bind altogether
```{r}
binned_all <- bind_rows(binned, binned_bind)
# Re-order labels so that figure is more intuitive
# binned_all$classes_pred <- factor(binned_all$classes_pred,
#                                   levels = c("destabilizing", "neutral", "stabilizing"))
binned_all$classes_actual <- factor(binned_all$classes_actual,
                                  levels = c("destabilizing", "neutral", "stabilizing"))

classification_error <- 
ggplot(binned_all, aes(fill = classes_actual, x = classes_pred)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("red", "darkgray", "blue"), name = "Actual class") +
  theme_classic() +
  labs(x = "Predicted class", y = "Frequency")
classification_error
#ggsave("../figures/classification_error.png", width = 7, height = 5)
```


Scatter plot
```{r}
error_correlation <-
binned_all %>%
  ggplot(aes(x = ddg_pred, y = ddg_exp)) +
  geom_point(aes(color = error)) +
  theme_classic() +
  scale_color_gradient(low = "blue", 
                        high = "red") +
  geom_point(data = binned_all[binned_all$test == FALSE,], 
             aes(x = ddg_pred, y = ddg_exp, color = error),
             shape = 4, size = 4) +
  labs(x = expression(paste(Delta, Delta, "G")[pred]),
       y = expression(paste(Delta, Delta, "G")[exp]))
error_correlation
```

```{r}
ggarrange(error_correlation, classification_error,
          labels = c("A","B"),
          ncol = 2)
ggsave("../figures/predicted_vs_actual.png", width = 12, height = 5)
```
```{r}
error_correlation <- 
binned_all %>%
  ggplot(aes(x = ddg_exp, y = ddg_pred)) +
  geom_point(aes(color = error)) +
  theme_bw() +
  scale_color_gradient(low = "chartreuse", 
                        high = "red4") +
  geom_point(data = binned_all[binned_all$test == FALSE,], 
             aes(x = ddg_exp, y = ddg_pred, color = error),
             shape = 4, size = 4) +
  labs(x = expression(paste(Delta, Delta, "G")[exp]~(kcal/mol)),
       y = expression(paste(Delta, Delta, "G")[pred]~(kcal/mol))) +
  theme(legend.position = c(.85, .75))
```

Try histogram?

```{r}
classification <- 
binned_all %>% ggplot(aes(x = ddg_exp)) +
  geom_histogram(binwidth = 0.2, position = "dodge",
                 aes(fill = classes_pred)) +
  geom_vline(xintercept = c(-.5, .5), linetype = 2, size = .2) +
  scale_fill_manual(values = c("blue", "gray40", "red"), name = "Predicted class") +
  theme_bw() +
  theme(legend.position = c(.8, .6)) +
  labs(x = expression(paste(Delta, Delta, "G")[exp]~(kcal/mol)),
       y = "Number of mutations")
```

Density plot?
```{r}
classification_density <- 
ggplot(aes(x = ddg_exp, fill = classes_pred), data = binned_all) +
  geom_density(alpha = .5) +
  geom_vline(xintercept = c(-.5, .5), linetype = 2, size = .2) +
  scale_fill_manual(values = c("blue", "gray40", "red"), name = "Predicted class") +
  theme_bw() +
  theme(legend.position = c(.8, .6)) +
  labs(x = expression(paste(Delta, Delta, "G")[exp]~(kcal/mol)))
```


```{r}
ggarrange(error_correlation, classification_density,
          labels = c("A","B"),
          ncol = 2)
ggsave("../figures/predicted_vs_actual3.png", width = 12, height = 5)
```

Does it look cleaner if I remove the borders?
```{r}
ggplot(aes(x = ddg_exp, fill = classes_pred), data = binned_all) +
  geom_density(alpha = .5, color = NA) +
  geom_vline(xintercept = c(-.5, .5), linetype = 2, size = .2) +
  scale_fill_manual(values = c("blue", "gray40", "red"), name = "Predicted class") +
  theme_bw() +
  theme(legend.position = c(.8, .6)) +
  labs(x = expression(paste(Delta, Delta, "G")[exp]~(kcal/mol)))
```

